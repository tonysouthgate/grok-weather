<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halstead Place Weather</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f4f8; /* Soft gray-blue background */
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #2c3e50; /* Dark blue for header */
        }
        .stations-container {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .station {
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            flex: 1;
            min-width: 250px;
        }
        .tempest {
            background-color: #9b59b6; /* Purple for Tempest Station */
            color: white;
        }
        .davis {
            background-color: #2c3e50; /* Black/dark navy for Davis Vantage Pro2 */
            color: #2ecc71; /* Green text for Davis */
        }
        .mean {
            background-color: #7f8c8d; /* Gray for Mean Values */
            color: white;
        }
        .weather-row {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
        }
        .tempest .weather-row:nth-child(odd) {
            background-color: rgba(255, 255, 255, 0.2); /* Light overlay for odd rows */
        }
        .tempest .weather-row:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.1); /* Darker overlay for even rows */
        }
        .davis .weather-row:nth-child(odd) {
            background-color: rgba(255, 255, 255, 0.1); /* Subtle light overlay for odd rows */
        }
        .davis .weather-row:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.2); /* Darker overlay for even rows */
        }
        .mean .weather-row:nth-child(odd) {
            background-color: rgba(255, 255, 255, 0.2); /* Light overlay for odd rows */
        }
        .mean .weather-row:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.1); /* Darker overlay for even rows */
        }
        .loading {
            text-align: center;
            color: #34495e;
        }
        .last-updated {
            text-align: center;
            color: #34495e;
            margin-top: 10px;
        }
        .logo {
            text-align: center;
            margin-bottom: 10px;
        }
        .logo img {
            max-width: 200px;
            height: auto;
        }
    </style>
</head>
<body>
    <h1>üå§Ô∏è Halstead Place Weather</h1>
    <div class="loading">Loading weather data...</div>
    <div class="last-updated">Last updated: --</div>

    <div class="stations-container">
        <div class="station tempest">
            <div class="logo"><img src="https://cdn.brandfetch.io/tempestwx.com/logo.svg" alt="Tempest Logo"></div>
            <h2>Tempest Station</h2>
            <div class="weather-row">
                <span>üå°Ô∏è Temperature</span>
                <span class="temp">-- ¬∞C</span>
            </div>
            <div class="weather-row">
                <span>üíß Dew Point</span>
                <span class="dew">-- ¬∞C</span>
            </div>
            <div class="weather-row">
                <span>üåä Pressure</span>
                <span class="pressure">-- hPa</span>
            </div>
            <div class="weather-row">
                <span>üí® Wind Speed</span>
                <span class="wind_speed">-- mph</span>
            </div>
            <div class="weather-row">
                <span>üß≠ Wind Dir</span>
                <span class="wind_dir">--¬∞ (--)</span>
            </div>
            <div class="weather-row">
                <span>üíß Humidity</span>
                <span class="humidity">-- %</span>
            </div>
            <div class="weather-row">
                <span>üåßÔ∏è 24hr Rain</span>
                <span class="rain">-- mm</span>
            </div>
        </div>

        <div class="station davis">
            <div class="logo"><img src="https://cdn.shopify.com/s/files/1/0515/5992/3873/files/3-1_Davis_Logo_Web_White.png?v=1614402315" alt="Davis Logo"></div>
            <h2>Davis Vantage Pro2</h2>
            <div class="weather-row">
                <span>üå°Ô∏è Temperature</span>
                <span class="temp">-- ¬∞C</span>
            </div>
            <div class="weather-row">
                <span>üíß Dew Point</span>
                <span class="dew">-- ¬∞C</span>
            </div>
            <div class="weather-row">
                <span>üåä Pressure</span>
                <span class="pressure">-- hPa</span>
            </div>
            <div class="weather-row">
                <span>üí® Wind Speed</span>
                <span class="wind_speed">-- mph</span>
            </div>
            <div class="weather-row">
                <span>üß≠ Wind Dir</span>
                <span class="wind_dir">--¬∞ (--)</span>
            </div>
            <div class="weather-row">
                <span>üíß Humidity</span>
                <span class="humidity">-- %</span>
            </div>
            <div class="weather-row">
                <span>üåßÔ∏è 24hr Rain</span>
                <span class="rain">-- mm</span>
            </div>
        </div>

        <div class="station mean">
            <h2>Mean Values</h2>
            <div class="weather-row">
                <span>üå°Ô∏è Temperature</span>
                <span class="temp">-- ¬∞C</span>
            </div>
            <div class="weather-row">
                <span>üíß Dew Point</span>
                <span class="dew">-- ¬∞C</span>
            </div>
            <div class="weather-row">
                <span>üåä Pressure</span>
                <span class="pressure">-- hPa</span>
            </div>
            <div class="weather-row">
                <span>üí® Wind Speed</span>
                <span class="wind_speed">-- mph</span>
            </div>
            <div class="weather-row">
                <span>üß≠ Wind Dir</span>
                <span class="wind_dir">--¬∞ (--)</span>
            </div>
            <div class="weather-row">
                <span>üíß Humidity</span>
                <span class="humidity">-- %</span>
            </div>
            <div class="weather-row">
                <span>üåßÔ∏è 24hr Rain</span>
                <span class="rain">-- mm</span>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loading = document.querySelector('.loading');
            const lastUpdated = document.querySelector('.last-updated');

            // Tempest API configuration
            const TEMPEST_API_URL = 'https://swd.weatherflow.com/swd/rest/observations/station/140578?token=02ec898b-0bad-4bc6-8517-dfc35cf3d845';

            // Function to calculate dew point using Magnus approximation (for Tempest)
            function calculateDewPoint(tempC, humidity) {
                const a = 17.27;
                const b = 237.7;
                const alpha = Math.log(humidity / 100) + (a * tempC) / (b + tempC);
                return (b * alpha) / (a - alpha);
            }

            // Function to convert wind direction degrees to text
            function getWindDirection(degrees) {
                const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
                const index = Math.round(degrees / 22.5) % 16;
                return directions[index];
            }

            // Function to update DOM for a station
            function updateStation(selector, data) {
                const rows = document.querySelectorAll(`${selector} .weather-row`);
                rows[0].querySelector('.temp').textContent = `${data.temp.toFixed(1)} ¬∞C`;
                rows[1].querySelector('.dew').textContent = `${data.dew.toFixed(1)} ¬∞C`;
                rows[2].querySelector('.pressure').textContent = `${data.pressure.toFixed(1)} hPa`;
                rows[3].querySelector('.wind_speed').textContent = `${data.windSpeed.toFixed(1)} mph`;
                rows[4].querySelector('.wind_dir').textContent = `${data.windDir}¬∞ (${data.windDirText})`;
                rows[5].querySelector('.humidity').textContent = `${data.humidity} %`;
                rows[6].querySelector('.rain').textContent = `${data.rain.toFixed(1)} mm`;
            }

            // Async function to load data
            async function loadData() {
                loading.textContent = 'Fetching weather data...';
                loading.style.display = 'block';
                lastUpdated.textContent = 'Last updated: --';

                try {
                    // Fetch Tempest data (client-side, as it supports CORS)
                    const tempestResponse = await fetch(TEMPEST_API_URL);
                    if (!tempestResponse.ok) throw new Error('Tempest API request failed');
                    const tempestJson = await tempestResponse.json();
                    const obs = tempestJson.obs[0];
                    const tempestData = {
                        temp: obs.air_temperature,
                        dew: calculateDewPoint(obs.air_temperature, obs.relative_humidity),
                        pressure: obs.station_pressure,
                        windSpeed: obs.wind_avg * 2.23694, // m/s to mph
                        windDir: obs.wind_direction,
                        windDirText: getWindDirection(obs.wind_direction),
                        humidity: obs.relative_humidity,
                        rain: obs.precip_accum_local_day,
                        ts: obs.timestamp
                    };

                    // Update Tempest
                    updateStation('.tempest', tempestData);

                    // Fetch Davis data via Netlify proxy function
                    const davisResponse = await fetch('/.netlify/functions/davis-proxy');
                    if (!davisResponse.ok) throw new Error('Davis proxy request failed');
                    const davisData = await davisResponse.json();
                    davisData.windDirText = getWindDirection(davisData.windDir);

                    // Update Davis
                    updateStation('.davis', davisData);

                    // Calculate mean values
                    const meanData = {
                        temp: (tempestData.temp + davisData.temp) / 2,
                        dew: (tempestData.dew + davisData.dew) / 2,
                        pressure: (tempestData.pressure + davisData.pressure) / 2,
                        windSpeed: (tempestData.windSpeed + davisData.windSpeed) / 2,
                        windDir: Math.round((tempestData.windDir + davisData.windDir) / 2),
                        windDirText: getWindDirection((tempestData.windDir + davisData.windDir) / 2),
                        humidity: Math.round((tempestData.humidity + davisData.humidity) / 2),
                        rain: (tempestData.rain + davisData.rain) / 2,
                        ts: Math.max(tempestData.ts, davisData.ts)
                    };

                    // Update Mean
                    updateStation('.mean', meanData);

                    // Update last collected time
                    const updateTime = new Date(meanData.ts * 1000).toLocaleString();
                    lastUpdated.textContent = `Last updated: ${updateTime}`;

                    loading.textContent = 'Data loaded!';
                    setTimeout(() => { loading.style.display = 'none'; }, 1000);
                } catch (error) {
                    console.error('Error fetching data:', error);
                    loading.textContent = 'Failed to load data (check console for details)';
                }
            }

            // Initial load
            loadData();

            // Auto-refresh every 5 minutes (300000 ms)
            setInterval(loadData, 300000);
        });
    </script>
</body>
</html>
